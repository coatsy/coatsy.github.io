<html><head>
<meta charset='UTF-8'>
<link href='resource/bootstrap.min.css' rel='Stylesheet' type='text/css' />
<link href='resource/style.css' rel='Stylesheet' type='text/css' />
</head>
<body>
<div id='page'>
<h1 class='entry-title'>Using the AdRotator Class + Dynamic Image Generation in ASP.NET 2.0</h1>
 <a class='url fn n profile-usercard-hover' href='https://social.msdn.microsoft.com/profile/Andrew Coates [MSFT]' target='_blank'>Andrew Coates [MSFT]</a>
<time>    11/7/2005 7:38:00 AM</time>
<hr>
<div id='content'><P>As part of my <A href="http://candrew.members.winisp.net/71-528/default.htm" mce_href="http://candrew.members.winisp.net/71%2D528/default.htm">study group</A> homework, I promised to bone up on the AdRotator class in ASP.NET2.0 and report back to the group. Turns out this lead to another cool thing that I needed to report back on - dynamic image generation.</P>
<P>The source code I’ll refer to throughout this post is available for <A href="http://candrew.members.winisp.net/files/AdRotator.zip" mce_href="http://candrew.members.winisp.net/files/AdRotator.zip">download</A>. Of course, it’s intended as a sample only. Use it at your own risk, no warranty expressed or implied, contents may be hot. Don’t say you weren’t warned. The source code demonstrates the 3 modes of populating an AdRotator control and a technique for dynamically displaying images stored as binary data in fields of a database.</P>
<H2>AdRotator Class</H2>
<P>The AdRotator class basically allows you to display a random image (more on where images come from and how "random" works in a bit) with an associated bit of ALT text and (optionally) a hyperlink from the image to somewhere else. You’ve seen this kind of thing on web pages before, in fact it goes back to ASP.NET 1.0 and has been implemented in any number of other web frameworks as well. Since we’ve been studying for the ASP.NET 2.0 exam, that’s what I’ll cover here.</P>
<H3>3 Modes</H3>
<P>AdRotator populates its image and navigation properties in 3 different ways, which I’ll call&nbsp;“Database”, “XML” and “Programmatic” for reasons that should become obvious, if they’re not already.</P>
<H3>Database</H3>
<P>In database mode, an AdRotator is linked to a DataSource that needs, at the very least, a column for the URL of the image, a column for the URL to navigate to when the imaged is clicked and a column for the string to be displayed in the ALT tag of the image. In the MSDN documentation (<A href="http://msdn2.microsoft.com/en-us/library/ms227550" target=_blank mce_href="http://msdn2.microsoft.com/en-us/library/ms227550">online</A>&nbsp;and <A href="ms-help://MS.VSCC.v80/MS.MSDN.v80/MS.VisualStudio.v80.en/dv_aspnetcon/html/2e86806a-e0bf-4d44-a7f5-b0047cb3d4db.htm" target=_blank mce_href="ms-help://MS.VSCC.v80/MS.MSDN.v80/MS.VisualStudio.v80.en/dv_aspnetcon/html/2e86806a-e0bf-4d44-a7f5-b0047cb3d4db.htm">offline</A>), the full allowable schema is listed and includes some compulsory fields:</P>
<UL>
<LI>An int primary key, which can be called anything you like 
<LI>an nvarchar field called “<STRONG>ImageURL</STRONG>” that has a relative or absolute&nbsp;URL pointing to the image to be displayed 
<LI>an nvarchar field called “<STRONG>NavigateURL</STRONG>” that has a relative or absolute URL that the image is hyperlinked to. If you leave the contents of this field blank, there’s no hyperlink from the image. 
<LI>an nvarchar field called “<STRONG>AlternateText</STRONG>” containing a string that will be inserted into the &lt;IMG&gt; tag’s ALT attribute (and will, therefore, depending on the viewing browser’s capabilities or preferences, be displayed as a tooltip, or instead of the image or be read aloud to the user etc). By the way, is it just me, or should this be called "Alternat<STRONG><FONT color=#ff0000>ive</FONT></STRONG>Text"?</LI></UL>
<P>Note that the name of these fields can be overridden in the AdRotator by setting the <STRONG>ImageURLField</STRONG>, <STRONG>NavigateURLField</STRONG> and <STRONG>AlternateTextField</STRONG> properties to the appropriate field name.</P>
<P>In addition, the following fields are optional.</P>
<UL>
<LI>an int&nbsp;field called “<STRONG>Impressions</STRONG>”. This is the relative weighting of each field and determines the likelihood of a particular image being displayed. You can use this field to do absolute weighting (where the impression values don’t change), or to smooth the curve somewhat by decrementing the value in the source data whenever an image is displayed (or when the hyperlink is clicked, or whatever). I can imagine putting something in this field like the amount of money each advertiser has given me to display their add. The more you give me, the better the chance your ad comes up. 
<LI>an nvarchar field called “<STRONG>Keyword</STRONG>”, which allows you to keep all your ads for the entire site (or perhaps many sites) in the one table and the instance of the AdRotator Class on a particular page can filter&nbsp;to just get the relevant&nbsp;ads for that page by setting the <STRONG>KeywordFilter</STRONG> property. 
<LI>int fields called “<STRONG>Width</STRONG>” and “<STRONG>Height</STRONG>”, which allow the AdRotator to include height and width hints as attributes of the generated &lt;IMG&gt; tag.</LI></UL>
<P>Of course, with the cool data handling functionality of data sources in ASP.NET 2.0, you don’t need a table anything like this, you can pull the data into the appropriate structure with a SQL statement in the DataSource itself. So, if you were dynamically displaying the thumbnail image from the ProductPhoto table in the AdventureWorks sample database, allowing a click to redirect to the LargePhoto image in the same table (again, dynamically rendered) and taking a description from the Product table for the Alternative text (OK, from now on I’ll call it Alternate text and grind my teeth), you could use something like</P><PRE class=code><FONT color=#0000ff>&lt;</FONT><FONT color=#800000>asp</FONT><FONT color=#0000ff>:</FONT><FONT color=#800000>SqlDataSource</FONT> <FONT color=#ff0000>ID</FONT><FONT color=#0000ff>="ProductPhotos"<BR>&nbsp; </FONT><FONT color=#ff0000>runat</FONT><FONT color=#0000ff>="server"<BR></FONT><FONT color=#ff0000>&nbsp; ConnectionString</FONT><FONT color=#0000ff>="</FONT><FONT size=+0>&lt;%$ ConnectionStrings:AdventureWorksConnectionString %&gt;</FONT><FONT color=#0000ff>"<BR></FONT><FONT color=#ff0000>&nbsp; SelectCommand</FONT><FONT color=#0000ff>="SELECT Production.ProductPhoto.ProductPhotoID AS ID, <BR>&nbsp;&nbsp;&nbsp; </FONT><FONT color=#0000ff>'./ProductThumbNail.ashx?ID='&nbsp;+ LTRIM(STR(Production.ProductPhoto.ProductPhotoID)) AS ImageUrl, <BR>&nbsp;&nbsp;&nbsp; './ProductPhoto.ashx?ID=' + LTRIM(STR(Production.ProductPhoto.ProductPhotoID)) AS NavigateUrl, <BR>&nbsp;&nbsp;&nbsp; Production.Product.Name AS AlternateText <BR>&nbsp;&nbsp;&nbsp; FROM Production.ProductPhoto <BR>&nbsp;&nbsp;&nbsp; INNER JOIN Production.ProductProductPhoto <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ON Production.ProductPhoto.ProductPhotoID = Production.ProductProductPhoto.ProductPhotoID <BR>&nbsp;&nbsp;&nbsp; INNER JOIN Production.Product <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ON Production.ProductProductPhoto.ProductID = Production.Product.ProductID"&gt;<BR></FONT><FONT color=#0000ff>&lt;/</FONT><FONT color=#800000>asp</FONT><FONT color=#0000ff>:</FONT><FONT color=#800000>SqlDataSource</FONT><FONT color=#0000ff>&gt;</FONT> </PRE>
<P>Which produces a resultset with the 4 required columns. Of course, writing SQL statements like that&nbsp;is much easier when you do it like this:</P>
<P><A href="http://candrew.members.winisp.net/blogimages/QueryBuilder.PNG" mce_href="http://candrew.members.winisp.net/blogimages/QueryBuilder.PNG"><IMG height=128 alt=QueryBuilder src="http://candrew.members.winisp.net/blogimages/QueryBuilder_thumb.jpg" width=120 border=0 mce_src="http://candrew.members.winisp.net/blogimages/QueryBuilder_thumb.jpg"></A> </P>
<P>The AdRotator control itself then looks like this:</P><PRE class=code><FONT color=#0000ff size=2>&lt;</FONT><FONT color=#800000 size=2>asp</FONT><FONT color=#0000ff size=2>:</FONT><FONT color=#800000 size=2>AdRotator</FONT><FONT size=2> </FONT><FONT color=#ff0000 size=2>ID</FONT><FONT color=#0000ff size=2>="AdRotator1"</FONT><FONT size=2> </FONT><FONT color=#ff0000 size=2>runat</FONT><FONT color=#0000ff size=2>="server"</FONT><FONT size=2> </FONT><FONT color=#ff0000 size=2>DataSourceID</FONT><FONT color=#0000ff size=2>="ProductPhotos"</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>/&gt;</FONT></PRE>
<P>All of the properties (except the DataSourceID and the name, of course) are left at their default values because I've used the default names for the fields in the DataSource definition.</P>
<H3>XML</H3>
<P>The next way to populate the fields of an AdRotator is to use a static XML file. It has a very similar structure to the schema of the table required for the Database method. All of the details of the schema are available in MSDN (<A href="http://msdn2.microsoft.com/en-us/library/d5kd8aka" target=_blank mce_href="http://msdn2.microsoft.com/en-us/library/d5kd8aka">online</A> and <A href="ms-help://MS.VSCC.v80/MS.MSDN.v80/MS.VisualStudio.v80.en/dv_aspnetcon/html/0d47e435-4f46-454e-b8ff-ad4e9b58ad40.htm" target=_blank mce_href="ms-help://MS.VSCC.v80/MS.MSDN.v80/MS.VisualStudio.v80.en/dv_aspnetcon/html/0d47e435-4f46-454e-b8ff-ad4e9b58ad40.htm">offline</A>). There’s an example file included in the accompanying <A href="http://candrew.members.winisp.net/files/AdRotator.zip" mce_href="http://candrew.members.winisp.net/files/AdRotator.zip">downloads</A>. Here's an extract (of a file called Advertisments.xml):</P><PRE class=code><FONT color=#0000ff size=2>
<P>&lt;</FONT><FONT color=#800000 size=2>Ad</FONT><FONT color=#0000ff size=2>&gt;<BR>&nbsp; </FONT><FONT color=#0000ff size=2>&lt;</FONT><FONT color=#800000 size=2>ImageUrl</FONT><FONT color=#0000ff size=2>&gt;</FONT><FONT size=2>~/ProductThumbNail.ashx?ID=70</FONT><FONT color=#0000ff size=2>&lt;/</FONT><FONT color=#800000 size=2>ImageUrl</FONT><FONT color=#0000ff size=2>&gt;<BR>&nbsp; &lt;</FONT><FONT color=#800000 size=2>NavigateUrl</FONT><FONT color=#0000ff size=2>&gt;</FONT><FONT size=2>~/ProductPhoto.ashx?ID=70</FONT><FONT color=#0000ff size=2>&lt;/</FONT><FONT color=#800000 size=2>NavigateUrl</FONT><FONT color=#0000ff size=2>&gt;<BR>&nbsp; &lt;</FONT><FONT color=#800000 size=2>AlternateText</FONT><FONT color=#0000ff size=2>&gt;</FONT><FONT size=2>Product Number 70</FONT><FONT color=#0000ff size=2>&lt;/</FONT><FONT color=#800000 size=2>AlternateText</FONT><FONT color=#0000ff size=2>&gt;<BR>&nbsp; &lt;</FONT><FONT color=#800000 size=2>Impressions</FONT><FONT color=#0000ff size=2>&gt;</FONT><FONT size=2>100</FONT><FONT color=#0000ff size=2>&lt;/</FONT><FONT color=#800000 size=2>Impressions</FONT><FONT color=#0000ff size=2>&gt;<BR>&lt;/</FONT><FONT color=#800000 size=2>Ad</FONT><FONT color=#0000ff size=2>&gt;</P>


</FONT></PRE>
<P>&nbsp;And the AdRotator looks like this</P><PRE class=code><FONT color=#0000ff size=2>
<P>&lt;</FONT><FONT color=#800000 size=2>asp</FONT><FONT color=#0000ff size=2>:</FONT><FONT color=#800000 size=2>AdRotator</FONT><FONT size=2> </FONT><FONT color=#ff0000 size=2>ID</FONT><FONT color=#0000ff size=2>="AdRotator2"</FONT><FONT size=2> </FONT><FONT color=#ff0000 size=2>runat</FONT><FONT color=#0000ff size=2>="server"</FONT><FONT size=2> </FONT><FONT color=#ff0000 size=2>AdvertisementFile</FONT><FONT color=#0000ff size=2>="~/Advertisments.xml"</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>/&gt;</P>


</FONT></PRE>
<P>Again, the default values work here because I’ve followed the naming conventions.</P>
<H3>Programmatic</H3>
<P>The third (and potentially most interesting from a developers’ point of view, although the database method is pretty cool too) is to populate the properties programmatically whenever the AdRotator AdCreated event fires (occurs once per round trip to the server after the creation of the control, but before the page is rendered). The event handler is passed an AdCreatedEventArgs object. You set the 3 properties, ImageURL, NavigateURL and AlternateText (familiar looking names aren’t they) and they are used to render the control.</P>
<P>The AdRotator control looks like this:</P><PRE class=code><FONT color=#0000ff size=2>
<P>&lt;</FONT><FONT color=#800000 size=2>asp</FONT><FONT color=#0000ff size=2>:</FONT><FONT color=#800000 size=2>AdRotator</FONT><FONT size=2> </FONT><FONT color=#ff0000 size=2>ID</FONT><FONT color=#0000ff size=2>="AdRotator3"</FONT><FONT size=2> </FONT><FONT color=#ff0000 size=2>runat</FONT><FONT color=#0000ff size=2>="server"</FONT><FONT size=2> </FONT><FONT color=#ff0000 size=2>OnAdCreated</FONT><FONT color=#0000ff size=2>="AdRotator3_AdCreated"</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>/&gt;</P>


</FONT></PRE>
<P>And in the code-behind file (mine's in C#, but VB.NET would work just as well), I just wired up an event handler (via the properties grid in my case, because I'm lazy)</P><PRE class=code><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>protected</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>void</FONT><FONT size=2> AdRotator3_AdCreated(</FONT><FONT color=#0000ff size=2>object</FONT><FONT size=2> sender, </FONT><FONT color=#008080 size=2>AdCreatedEventArgs</FONT><FONT size=2> e)<BR>{<BR><FONT color=#008000 size=2>&nbsp; // Just for this example - see the download for a different way of using ProductID<BR></FONT></FONT><FONT size=2><FONT color=#0000ff size=2>&nbsp; int</FONT><FONT size=2> ProductID = 1;<BR>&nbsp;&nbsp;</FONT>e.ImageUrl = </FONT><FONT color=#800000 size=2>"~/ProductThumbNail.ashx?ID="</FONT><FONT size=2> + ProductID.ToString();<BR>&nbsp; e.NavigateUrl = </FONT><FONT color=#800000 size=2>"~/ProductPhoto.ashx?ID="</FONT><FONT size=2> + ProductID.ToString();<BR>&nbsp; e.AlternateText = </FONT><FONT color=#800000 size=2>"Programatically generated text for product ID "</FONT><FONT size=2> + ProductID.ToString();<BR>}</P>


</FONT></PRE>
<P>This is potentially very powerful. You could do real-time image targeting based on the navigation history of this user, based on personalisation they’ve done or any number of other criteria.</P>
<H2>Dynamic Image Generation</H2>
<P>Up until now, I’ve glossed over the fact that the AdRotator class expects URLs pointing to images, not byte streams or arrays of binary data, or anything else that might represent an image. This potentially presents a problem when (as we have in our example), the images are stored as binary data in a database file. You don’t want to have to write them out to disk, where they’ll take up as much space again and need to be kept in sync with the database version. Up until Beta 1 of VS2005, it looked like this was going to be very easy, just use the Dynamic Image Control. Alas, it was dropped between Beta 1 and Beta 2 (see <A href="http://msdn.microsoft.com/asp.net/beta2/beta2changes.aspx" mce_href="http://msdn.microsoft.com/asp.net/beta2/beta2changes.aspx">http://msdn.microsoft.com/asp.net/beta2/beta2changes.aspx</A>). Fortunately, that very same page lists some code that can be adapted to do exactly what we need.</P>
<P>Essentially, we need to create an HTTP Handler class that intercepts calls to a particular URL and returns the image in a format that the browser expects. There are docs on the IHTTPHandler interface (which the specialised dynamic image generation classes in the example implement) in the MSDN docs (<A href="http://msdn2.microsoft.com/en-us/library/system.web.ihttphandler.aspx" target=_blank mce_href="http://msdn2.microsoft.com/en-us/library/system.web.ihttphandler.aspx">online</A> and <A href="ms-help://MS.VSCC.v80/MS.MSDN.v80/MS.NETDEVFX.v20.en/cpref12/html/T_System_Web_IHttpHandler.htm" target=_blank mce_href="ms-help://MS.VSCC.v80/MS.MSDN.v80/MS.NETDEVFX.v20.en/cpref12/html/T_System_Web_IHttpHandler.htm">offline</A>). HTTP handlers give you a means of interacting with the low-level request and response services of the IIS Web server and provide functionality much like ISAPI extensions but with a simpler programming model.</P>
<P>Here’s the code for one of the Handler classes (ProductThumbNail.ashx). The other one is identical, except a different TableAdaptor is used to retrieve the bigger photo.</P><PRE class=code><FONT size=2>
<P>&lt;%</FONT><FONT color=#0000ff size=2>@</FONT><FONT size=2> </FONT><FONT color=#800000 size=2>WebHandler</FONT><FONT size=2> </FONT><FONT color=#ff0000 size=2>Language</FONT><FONT color=#0000ff size=2>="C#"</FONT><FONT size=2> </FONT><FONT color=#ff0000 size=2>Class</FONT><FONT color=#0000ff size=2>="ProductThumbNail"</FONT><FONT size=2> %&gt;</P>


</FONT><FONT color=#0000ff size=2>
<P>using</FONT><FONT size=2> System;<BR></FONT><FONT color=#0000ff size=2>using</FONT><FONT size=2> System.Drawing;<BR></FONT><FONT color=#0000ff size=2>using</FONT><FONT size=2> System.Drawing.Imaging;<BR></FONT><FONT color=#0000ff size=2>using</FONT><FONT size=2> System.IO;<BR></FONT><FONT color=#0000ff size=2>using</FONT><FONT size=2> System.Web;<BR></FONT><FONT color=#0000ff size=2>using</FONT><FONT size=2> System.Web.Caching;<BR></FONT><FONT color=#0000ff size=2>using</FONT><FONT size=2> System.Data;<BR></FONT><FONT color=#0000ff size=2>using</FONT><FONT size=2> System.Data.Sql;<BR></FONT><FONT color=#0000ff size=2>using</FONT><FONT size=2> System.Web.UI.WebControls;<BR></FONT><FONT color=#0000ff size=2>using</FONT><FONT size=2> System.Web.Configuration;<BR></FONT><FONT color=#0000ff size=2>using</FONT><FONT size=2> System.Configuration;<BR></FONT><FONT color=#0000ff size=2>using</FONT><FONT size=2> System.Collections;</P>


</FONT><FONT color=#0000ff size=2>
<P>public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>class</FONT><FONT size=2> </FONT><FONT color=#008080 size=2>ProductThumbNail</FONT><FONT size=2> : </FONT><FONT color=#008080 size=2>IHttpHandler<BR></FONT><FONT size=2>{<BR>&nbsp; </FONT><FONT color=#0000ff size=2>public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>void</FONT><FONT size=2> ProcessRequest (</FONT><FONT color=#008080 size=2>HttpContext</FONT><FONT size=2> context) {<BR><BR></FONT><FONT color=#008000 size=2>&nbsp;&nbsp;&nbsp; // Get the image ID from querystring, and use it to generate a cache key.<BR>&nbsp;&nbsp;&nbsp; </FONT><FONT color=#008080 size=2>String</FONT><FONT size=2> imageID = context.Request.QueryString[</FONT><FONT color=#800000 size=2>"ID"</FONT><FONT size=2>];<BR>&nbsp;&nbsp;&nbsp; </FONT><FONT color=#008080 size=2>String</FONT><FONT size=2> cacheKey = context.Request.CurrentExecutionFilePath + </FONT><FONT color=#800000 size=2>":"</FONT><FONT size=2> + imageID;<BR><BR>&nbsp;&nbsp;&nbsp; </FONT><FONT color=#008080 size=2>Byte</FONT><FONT size=2>[] imageBytes;<BR>&nbsp;&nbsp;&nbsp; <BR>&nbsp;&nbsp;&nbsp; </FONT><FONT color=#008000 size=2>// Check if the cache contains the image.<BR>&nbsp;&nbsp;&nbsp; </FONT><FONT color=#008080 size=2>Object</FONT><FONT size=2> cachedImageBytes = context.Cache.Get(cacheKey);<BR><FONT color=#008000>&nbsp;&nbsp;&nbsp; <BR>&nbsp;&nbsp;&nbsp; </FONT></FONT><FONT color=#0000ff size=2>if</FONT><FONT size=2> (cachedImageBytes != </FONT><FONT color=#0000ff size=2>null</FONT><FONT size=2>)<BR>&nbsp;&nbsp;&nbsp; {<BR><FONT color=#008000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT>imageBytes = (</FONT><FONT color=#008080 size=2>Byte</FONT><FONT size=2>[])cachedImageBytes;<BR><FONT color=#008000>&nbsp;&nbsp;&nbsp; </FONT>}<BR><FONT color=#008000>&nbsp;&nbsp;&nbsp; </FONT></FONT><FONT color=#0000ff size=2>else<BR><FONT color=#008000>&nbsp;&nbsp;&nbsp; </FONT></FONT><FONT size=2>{<BR><FONT color=#008000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT>GetImageTableAdapters.</FONT><FONT color=#008080 size=2>ThumbNailTableAdapter</FONT><FONT size=2> oTA = </FONT><FONT color=#0000ff size=2>new</FONT><FONT size=2> GetImageTableAdapters.</FONT><FONT color=#008080 size=2>ThumbNailTableAdapter</FONT><FONT size=2>();<BR><FONT color=#008000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT></FONT><FONT color=#008080 size=2>GetImage</FONT><FONT size=2>.</FONT><FONT color=#008080 size=2>ThumbNailDataTable</FONT><FONT size=2> oDT = oTA.GetData(</FONT><FONT color=#0000ff size=2>int</FONT><FONT size=2>.Parse(imageID));<BR><FONT color=#008000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR><FONT color=#008000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT></FONT></FONT><FONT color=#0000ff size=2>if</FONT><FONT size=2> (oDT.Rows.Count == 0)<BR><FONT color=#008000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT>{<BR><FONT color=#008000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT></FONT><FONT color=#008000 size=2>// MAGIC NUMBER!<BR><FONT color=#008000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT></FONT><FONT size=2></FONT><FONT color=#008000 size=2>// Photo ID 1 displays "No Image Available" image<BR><FONT color=#008000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT></FONT><FONT size=2>oDT = oTA.GetData(1);<BR><FONT color=#008000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT>}<BR><FONT color=#008000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR><FONT color=#008000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT></FONT>imageBytes = (</FONT><FONT color=#0000ff size=2>byte</FONT><FONT size=2>[])oDT.Rows[0][</FONT><FONT color=#800000 size=2>"ThumbNailPhoto"</FONT><FONT size=2>];<BR><FONT color=#008000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR><FONT color=#008000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT></FONT></FONT><FONT color=#008000 size=2>// Store it in the cache (to be expired after 2 hours).<BR><FONT color=#008000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT></FONT><FONT size=2>context.Cache.Add(cacheKey, imageBytes, </FONT><FONT color=#0000ff size=2>null</FONT><FONT size=2>,&nbsp;<BR><FONT color=#008000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT></FONT><FONT color=#008080 size=2>DateTime</FONT><FONT size=2>.MaxValue, </FONT><FONT color=#0000ff size=2>new</FONT><FONT size=2> </FONT><FONT color=#008080 size=2>TimeSpan</FONT><FONT size=2>(2, 0, 0),&nbsp;<BR><FONT color=#008000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT></FONT><FONT color=#008080 size=2>CacheItemPriority</FONT><FONT size=2>.Normal, </FONT><FONT color=#0000ff size=2>null</FONT><FONT size=2>);<BR><FONT color=#008000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR><FONT color=#008000>&nbsp;&nbsp;&nbsp;&nbsp;</FONT></FONT>}<BR><FONT color=#008000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR><FONT color=#008000>&nbsp;&nbsp;&nbsp;&nbsp;</FONT></FONT></FONT><FONT color=#008000 size=2>// Send back image.<BR><FONT color=#008000>&nbsp;&nbsp;&nbsp;&nbsp;</FONT></FONT><FONT size=2>context.Response.ContentType = </FONT><FONT color=#800000 size=2>"image/jpeg"</FONT><FONT size=2>;<BR><FONT color=#008000>&nbsp;&nbsp;&nbsp;&nbsp;</FONT>context.Response.Cache.SetCacheability(</FONT><FONT color=#008080 size=2>HttpCacheability</FONT><FONT size=2>.Public);<BR><FONT color=#008000>&nbsp;&nbsp;&nbsp;&nbsp;</FONT>context.Response.BufferOutput = </FONT><FONT color=#0000ff size=2>false</FONT><FONT size=2>;<BR><FONT color=#008000>&nbsp;&nbsp;&nbsp;&nbsp;</FONT>context.Response.OutputStream.Write(imageBytes, 0, imageBytes.Length);<BR><FONT color=#008000>&nbsp;&nbsp;</FONT>}<BR><FONT color=#008000>&nbsp;&nbsp;<BR><FONT color=#008000>&nbsp;&nbsp;</FONT></FONT></FONT><FONT color=#0000ff size=2>public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>bool</FONT><FONT size=2> IsReusable {<BR><FONT color=#008000>&nbsp;&nbsp;&nbsp; </FONT></FONT><FONT color=#0000ff size=2>get</FONT><FONT size=2> {<BR><FONT color=#008000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT></FONT><FONT color=#0000ff size=2>return</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>false</FONT><FONT size=2>;<BR><FONT color=#008000>&nbsp;&nbsp;&nbsp; </FONT>}<BR><FONT color=#008000>&nbsp;&nbsp;</FONT>}<BR>}</P>


</FONT></FONT></PRE>
<P>The important method to implement in the IHTTPHandler interface is ProcessRequest(). This gives you low-level access to the context object which, in turn, gives to access to the Request and Response objects so you can get the ID passed as a query string in the URL (using Request) and shove stuff back out with the Response object. The stuff to shove back out is just a byte array grabbed from the binary column in the table. Notice, I’ve just grabbed the contents of the ThumbNailPhoto column in the first row and cast it to a byte array.</P>
<P>To send the image back, just set the content type (note that this could come from the table as well, or could be dynamically determined from the header in the binary if required), tell the Response object just to stream the bits back, don't wait for the stream to close, and then just write the byte array to the output stream.</P>
<P>A couple of other things to note here (and I’m not claiming they’re best practice – comments always welcome):</P>
<H3>Using a DataSet to retrieve data from the server</H3>
<P>Notice that instead of programatically creating connections and commands, I’ve opted to create a dataset (GetImage.xsd in the App_Code folder) with a couple of table adaptors. The naming convention adopted by ASP.NET gets me every time I use these. The TableAdaptors are in the &lt;DataSetName&gt;TableAdaptors namespace and aren’t available to intellisense until you’ve built the project after the xsd is created. The data tables are classes of the &lt;DataSetName&gt; class. So in this case The GetImageTableAdaptors namespace contains the ThumbNailTableAdaptor and the ProductPhotoTableAdaptor classes. The GetImage class has two properties – instances of the ThumbNail and ProductPhoto classes.</P>
<P>Configuring these datasets is heaps easier than remembering how to use them. Just add a DataSet to the project and the first TableAdaptor is added automatically. I added a very simple SQL statement with a parameter (the ProductPhotoID) to return a single row. To add the other, just right-click on the xsd design surface and choose Add TableAdaptor.</P>
<P>Note that I’ve opted for the very simplest Table Adaptors – no INSERT, UPDATE or DELETE clauses. These are only ever designed to be read-only.</P>
<H3>Caching Images</H3>
<P>This bit was already in the code on the MSDN site about the DynamicImageControl being pulled, but I left it in there because it seemed like such a good idea. The cache engine takes a key to see whether it has already looked up the image and stored it for future use. In this case I’ve left the cache duration at 2 hours. Obviously, you’d massage this based on how often images were likely to change.</P></div>
</div></body>
<script type='text/javascript' src='resource/jquery-1.12.1.min.js'></script>
<script type='text/javascript' src='resource/replace.js'></script>
</html>
