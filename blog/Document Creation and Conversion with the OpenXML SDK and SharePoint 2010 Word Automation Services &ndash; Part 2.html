<html><head>
<meta charset='UTF-8'>
<link href='resource/bootstrap.min.css' rel='Stylesheet' type='text/css' />
<link href='resource/style.css' rel='Stylesheet' type='text/css' />
</head>
<body>
<div id='page'>
<h1 class='entry-title'>Document Creation and Conversion with the OpenXML SDK and SharePoint 2010 Word Automation Services &ndash; Part 2</h1>
 <a class='url fn n profile-usercard-hover' href='https://social.msdn.microsoft.com/profile/Andrew Coates [MSFT]' target='_blank'>Andrew Coates [MSFT]</a>
<time>    4/6/2011 1:35:35 AM</time>
<hr>
<div id='content'><p>A long time ago, I wrote <a href="http://blogs.msdn.com/b/acoat/archive/2010/06/19/document-creation-and-conversion-with-the-openxml-sdk-and-sharepoint-2010-word-automation-services.aspx">Part 1 of this post</a>, based on the presentation I did at the 2010 SharePoint Conference in Sydney. If you're following along with the code, you may want to review that post so you can set up your development environment to match mine.</p>  <p>To quickly recap, the last post showed how to create Word (OpenXML, docx) documents programmatically and write them to disk using the OpenXML SDK (and therefore without the requirement for Word/Office on the machine creating the documents).</p>  <p>In this part, I'll extend the solution to write the documents to a document library in SharePoint and then use Word Automation Services to automatically convert the docx files to PDF format.</p>  <h2>Setup</h2>  <p>To follow along with this walkthrough without changes, setup your SharePoint instance (at http://localhost) as follows:</p>  <ul>   <li>Create a document library called &quot;Created Docs&quot; in the root site </li>    <li>Create a document library called &quot;Converted Docs&quot; in the root site </li> </ul>  <p>If you use a remote server, and/or a different site or library names, you'll need to adjust some of the URI and path strings in the code below to make it work.</p>  <h2>Writing to a SharePoint Library</h2>  <p>Carrying on from last time, wire up the click event of the <font face="Consolas">CreateOneSharePointDocumentButton</font>:</p>  <div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:f033cdb8-c887-46fd-b256-61126b695124" class="wlWriterEditableSmartContent"> <div style="border: #000080 1px solid; color: #000; font-family: 'Courier New', Courier, Monospace; font-size: 10pt"> <div style="background: #000080; color: #fff; font-family: Verdana, Tahoma, Arial, sans-serif; font-weight: bold; padding: 2px 5px">Click event handler</div> <div style="background: #ddd; overflow: auto"> <ol style="background: #ffffff; margin: 0 0 0 2em; padding: 0 0 0 5px;"> <li><span style="color:#0000ff">private</span> <span style="color:#0000ff">void</span> CreateOneDocumentOnSharePointButton_Click(<span style="color:#0000ff">object</span> sender, <span style="color:#2b91af">EventArgs</span> e)</li> <li style="background: #f3f3f3">{</li> <li>    gen.CreateOneDocumentOnSharePoint();</li> <li style="background: #f3f3f3">}</li> </ol> </div> </div> </div>  <p>Generate a stub for the <font face="Consolas">CreateOneDocumentOnSharePoint()</font> method in the <font face="Consolas">DocGenerator</font> class using the <font face="Consolas">Ctrl+.</font> technique made possible by the <a href="http://visualstudiogallery.msdn.microsoft.com/d0d33361-18e2-46c0-8ff2-4adea1e34fef/">Visual Studio 2010 Productivity Power Tools</a>.</p>  <p>Switch to and add a using statement to the <font face="Consolas">DocGenerator</font> class to give you access to the SharePoint Client Libraries - giving it an alias will help disambiguate the <font face="Consolas">File</font> class later:</p>  <div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:f274e30c-3655-41d3-a80a-0f2e14aa427b" class="wlWriterEditableSmartContent"> <div style="border: #000080 1px solid; color: #000; font-family: 'Courier New', Courier, Monospace; font-size: 10pt"> <div style="background: #ddd; overflow: auto"> <ol style="background: #ffffff; margin: 0 0 0 2em; padding: 0 0 0 5px;"> <li><span style="color:#0000ff">using</span> SPC = Microsoft.SharePoint.Client;</li> </ol> </div> </div> </div>  <p>Using the SharePoint Client Libraries, it's very easy to write documents to a document library, and there's no need to write a document to a local drive. This means we'll use a different overload of the OpenXML SDK's <font face="Consolas">WordprocessingDocument.Create()</font> method that writes, not to a file, but to a <font face="Consolas">MemoryStream</font>.</p>  <div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:58f83775-a7f9-4212-8fd1-510f917587ef" class="wlWriterEditableSmartContent"> <div style="border: #000080 1px solid; color: #000; font-family: 'Courier New', Courier, Monospace; font-size: 10pt"> <div style="background: #000080; color: #fff; font-family: Verdana, Tahoma, Arial, sans-serif; font-weight: bold; padding: 2px 5px">CreateOneDocumentOnSharePoint</div> <div style="background: #ddd; overflow: auto"> <ol style="background: #ffffff; margin: 0 0 0 2.5em; padding: 0 0 0 5px;"> <li><span style="color:#0000ff">internal</span> <span style="color:#0000ff">void</span> CreateOneDocumentOnSharePoint()</li> <li style="background: #f3f3f3">{</li> <li>  SPC.<span style="color:#2b91af">ClientContext</span> clientContext = <span style="color:#0000ff">new</span> SPC.<span style="color:#2b91af">ClientContext</span>(<span style="color:#a31515">&quot;http://localhost&quot;</span>);</li> <li style="background: #f3f3f3">  <span style="color:#0000ff">string</span> fileUrl = <span style="color:#a31515">&quot;/Created Docs/MyVeryVeryCoolDoc.docx&quot;</span>;</li> <li>&nbsp;</li> <li style="background: #f3f3f3">  sw.Reset();</li> <li>  sw.Start();</li> <li style="background: #f3f3f3">&nbsp;</li> <li>  <span style="color:#0000ff">using</span> (<span style="color:#2b91af">MemoryStream</span> ms = gen.CreatePackage())</li> <li style="background: #f3f3f3">  {</li> <li>    ms.Seek(0, <span style="color:#2b91af">SeekOrigin</span>.Begin);</li> <li style="background: #f3f3f3">    SPC.<span style="color:#2b91af">File</span>.SaveBinaryDirect(clientContext, fileUrl, ms, <span style="color:#0000ff">true</span>);</li> <li>  }</li> </ol> </div> </div> </div>  <p>In this code, you create a new <font face="Consolas">SharePoint.Client.ClientContext</font> that gives access to the site (in this case at <font face="Consolas">http://localhost</font>, but if you've got things set up differently, change it here).</p>  <p>Create an overload of the <font face="Consolas">CreatePackage()</font> method in the <font face="Consolas">DocumentCreator</font> class that creates and populates a <font face="Consolas">MemoryStream</font>:</p>  <div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:0d347603-3302-4194-b875-a978853a081b" class="wlWriterEditableSmartContent"> <div style="border: #000080 1px solid; color: #000; font-family: 'Courier New', Courier, Monospace; font-size: 10pt"> <div style="background: #000080; color: #fff; font-family: Verdana, Tahoma, Arial, sans-serif; font-weight: bold; padding: 2px 5px">CreatPackage Overload</div> <div style="background: #ddd; overflow: auto"> <ol style="background: #ffffff; margin: 0 0 0 2.5em; padding: 0 0 0 5px;"> <li><span style="color:#0000ff">internal</span> <span style="color:#2b91af">MemoryStream</span> CreatePackage()</li> <li style="background: #f3f3f3">{</li> <li>&nbsp;</li> <li style="background: #f3f3f3">  <span style="color:#2b91af">MemoryStream</span> ms = <span style="color:#0000ff">new</span> <span style="color:#2b91af">MemoryStream</span>();</li> <li>  <span style="color:#0000ff">using</span> (<span style="color:#2b91af">WordprocessingDocument</span> package = </li> <li style="background: #f3f3f3">    <span style="color:#2b91af">WordprocessingDocument</span>.Create</li> <li>    (ms, <span style="color:#2b91af">WordprocessingDocumentType</span>.Document))</li> <li style="background: #f3f3f3">  {</li> <li>    CreateParts(package);</li> <li style="background: #f3f3f3">  }</li> <li>&nbsp;</li> <li style="background: #f3f3f3">  <span style="color:#0000ff">return</span> ms;</li> <li>&nbsp;</li> <li style="background: #f3f3f3">}</li> </ol> </div> </div> </div>  <p>Move the pointer to the start of the <font face="Consolas">MemoryStream</font> and call the <font face="Consolas">File.SaveBinaryDirect()</font> method passing in the <font face="Consolas">ClientContext</font>, a string indicating where the file should be written, the stream and a boolean that tells SharePoint whether or not to overwrite an existing file with the same name.</p>  <p>Running the app and clicking the One document in SharePoint button shows that it's very fast - in my case 102ms</p>  <p><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="Writing 1 document to SharePoint took 0.1 seconds" border="0" alt="Writing 1 document to SharePoint took 0.1 seconds" src="media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/00/39/01/metablogapi/5140.image_4738DF59.png" original-url="http://blogs.msdn.com/cfs-file.ashx/__key/CommunityServer-Blogs-Components-WeblogFiles/00-00-00-39-01-metablogapi/5140.image_5F00_4738DF59.png" width="385" height="175" /></p>  <p>Writing lots of documents is fast too - add an event handler to the <font face="Consolas">CreateOneSharePointDocumentButton</font>:</p>  <div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:c0b12577-b69c-4f32-ac20-d5d4eb33302a" class="wlWriterEditableSmartContent"> <div style="border: #000080 1px solid; color: #000; font-family: 'Courier New', Courier, Monospace; font-size: 10pt"> <div style="background: #000080; color: #fff; font-family: Verdana, Tahoma, Arial, sans-serif; font-weight: bold; padding: 2px 5px">Click Event Handler</div> <div style="background: #ddd; overflow: auto"> <ol style="background: #ffffff; margin: 0 0 0 2em; padding: 0 0 0 5px;"> <li><span style="color:#0000ff">private</span> <span style="color:#0000ff">void</span> CreateManyDocumentsOnSharePointButton_Click(<span style="color:#0000ff">object</span> sender, <span style="color:#2b91af">EventArgs</span> e)</li> <li style="background: #f3f3f3">{</li> <li>  gen.CreateManyDocumentsOnSharePointInParallel((<span style="color:#0000ff">int</span>)NumberOfDocumentsToCreate.Value);</li> <li style="background: #f3f3f3">&nbsp;</li> <li>}</li> </ol> </div> </div> </div>  <p>And add a <font face="Consolas">CreateManyDocumentsOnSharePointInParallel()</font> method that uses a <font face="Consolas">Parallel.For()</font> loop to call <font face="Consolas">CreatePackage()</font> and <font face="Consolas">File.SaveBinaryDirect()</font> for as many files as you create:</p>  <div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:b5808218-fa97-433f-a84b-5ab5090f77ed" class="wlWriterEditableSmartContent"> <div style="border: #000080 1px solid; color: #000; font-family: 'Courier New', Courier, Monospace; font-size: 10pt"> <div style="background: #000080; color: #fff; font-family: Verdana, Tahoma, Arial, sans-serif; font-weight: bold; padding: 2px 5px">Create lots of SharePoint Docs</div> <div style="background: #ddd; overflow: auto"> <ol style="background: #ffffff; margin: 0 0 0 2.5em; padding: 0 0 0 5px;"> <li><span style="color:#0000ff">internal</span> <span style="color:#0000ff">void</span> CreateManyDocumentsOnSharePointInParallel(<span style="color:#0000ff">int</span> NumberOfDocs)</li> <li style="background: #f3f3f3">{</li> <li>  SPC.<span style="color:#2b91af">ClientContext</span> clientContext = <span style="color:#0000ff">new</span> SPC.<span style="color:#2b91af">ClientContext</span>(<span style="color:#a31515">&quot;http://localhost&quot;</span>);</li> <li style="background: #f3f3f3">  <span style="color:#0000ff">string</span> fileUrl = <span style="color:#a31515">&quot;/Created Docs/MyEvenCoolerDoc{0:D5}.docx&quot;</span>;</li> <li>&nbsp;</li> <li style="background: #f3f3f3">  sw.Reset();</li> <li>  sw.Start();</li> <li style="background: #f3f3f3">&nbsp;</li> <li>  <span style="color:#2b91af">Parallel</span>.For(0, NumberOfDocs, i =&gt;</li> <li style="background: #f3f3f3">  {</li> <li>&nbsp;</li> <li style="background: #f3f3f3">    <span style="color:#0000ff">using</span> (<span style="color:#2b91af">MemoryStream</span> ms = gen.CreatePackage())</li> <li>    {</li> <li style="background: #f3f3f3">      ms.Seek(0, <span style="color:#2b91af">SeekOrigin</span>.Begin);</li> <li>      SPC.<span style="color:#2b91af">File</span>.SaveBinaryDirect(clientContext, <span style="color:#0000ff">string</span>.Format(fileUrl, i), ms, <span style="color:#0000ff">true</span>);</li> <li style="background: #f3f3f3">    }</li> <li>&nbsp;</li> <li style="background: #f3f3f3">  });</li> <li>&nbsp;</li> <li style="background: #f3f3f3">  sw.Stop();</li> <li>&nbsp;</li> <li style="background: #f3f3f3">  System.Windows.Forms.<span style="color:#2b91af">MessageBox</span>.Show(<span style="color:#0000ff">string</span>.Format(</li> <li>      <span style="color:#a31515">&quot;Wrote {3} documents to SharePoint ({1}{2}) in {0} ms (using parallel processing)&quot;</span>,</li> <li style="background: #f3f3f3">      sw.ElapsedMilliseconds,</li> <li>      clientContext.Url,</li> <li style="background: #f3f3f3">      fileUrl,</li> <li>      NumberOfDocs));</li> <li style="background: #f3f3f3">&nbsp;</li> <li>}</li> </ol> </div> </div> </div>  <p>This is also pretty fast - in my case 40ms per document.</p>  <p><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="Writing 100 documents to SharePoint (in parallel) took 4 seconds" border="0" alt="Writing 100 documents to SharePoint (in parallel) took 4 seconds" src="media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/00/39/01/metablogapi/1830.image_57C0B47A.png" original-url="http://blogs.msdn.com/cfs-file.ashx/__key/CommunityServer-Blogs-Components-WeblogFiles/00-00-00-39-01-metablogapi/1830.image_5F00_57C0B47A.png" width="457" height="169" /></p>  <p>Navigating to the document library shows all those documents sitting just where you'd expect to see them:</p>  <p><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="Cool documents created en-masse" border="0" alt="Cool documents created en-masse" src="media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/00/39/01/metablogapi/1665.image_15016942.png" original-url="http://blogs.msdn.com/cfs-file.ashx/__key/CommunityServer-Blogs-Components-WeblogFiles/00-00-00-39-01-metablogapi/1665.image_5F00_15016942.png" width="644" height="398" /></p>  <h2>Converting Word Documents to a Fixed Format (PDF or XPS)</h2>  <p><img style="background-image: none; border-right-width: 0px; margin: 0px 5px 0px 0px; padding-left: 0px; padding-right: 0px; display: inline; float: left; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="PDF" border="0" alt="PDF" align="left" src="media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/00/39/01/metablogapi/8524.PDF_79000E7C.png" original-url="http://blogs.msdn.com/cfs-file.ashx/__key/CommunityServer-Blogs-Components-WeblogFiles/00-00-00-39-01-metablogapi/8524.PDF_5F00_79000E7C.png" width="116" height="160" />Up until now, we've not had to use Word (or any other Office client) as all we've been doing is generating documents, not rendering them. Just like you can create an HTML document without requiring a browser, it's perfectly valid to create a Word document (or any other OpenXML format document) without using Word. </p>  <p>However, to view the document, or to create a fixed version of it like PDF or XPS, it's necessary to render it. Up until the release of SharePoint 2010, the highest fidelity way to do this was to open the document in Word. Of course, doing that on the server was fraught with difficulty. Word is not designed to be a server-side tool - it throws (sometimes modal) dialogs, it spends a lot of resources on updating the screen and it's not optimised for multi-processor, large memory scenarios. When there is a user interacting with Word though, the bottleneck is rarely the computer.</p>  <p>The SharePoint team addressed this problem with the Word Automation Services feature in SharePoint 2010 (standard edition and higher). Word Automation Services is the client code from Word with the UI bits stripped out and optimised to run as a server process. All of the rendering engine is available for SharePoint to use without any of the issues (both technical and from a licensing point of view) of using Word on a server. There's lots of great info on Word Automation Services on MSDN and elsewhere. Here's the list of resources I provided in the first post in this series:</p>  <ul>   <li><a href="http://blogs.msdn.com/b/ericwhite/archive/2010/03/17/developing-with-sharepoint-2010-word-automation-services.aspx">Developing with SharePoint 2010 Word Automation Services</a> </li>    <li><a href="http://blogs.msdn.com/b/microsoft_office_word/archive/2009/10/26/introducing-word-automation-services.aspx">Introducing Word Automation Services</a> </li>    <li><a href="http://blogs.msdn.com/b/microsoft_office_word/archive/2009/12/16/word-automation-services_3a00_-what-it-does.aspx">Word Automation Services: What It Does</a> </li>    <li><a href="http://msdn.microsoft.com/en-us/library/ee557736(office.14).aspx">Programming Word Automation Services</a> </li>    <li><a href="http://msdn.microsoft.com/en-us/library/ff433638(office.14).aspx">Building Document Generation Systems from Templates using Word 2007 and Word 2010</a> </li> </ul>  <p>Word Automation Services (WAS) document conversion jobs run as as an asynchronous server-side job that can either be scheduled automatically (for example, when a document is placed in a folder) or programmatically. Either way, the job won't start immediately, just the next time the WAS scheduler runs. The frequency of the scheduler running is set in Central Administration - see the links above for details on how to set it up. I set it to the minimum interval - one minute.</p>  <p>Interacting programmatically with the service is pretty straightforward, but there are two gotchas:</p>  <ol>   <li>the .NET libraries are 3.5 only, so the project you create must be a .NET 3.5 project, and </li>    <li>the calls will fail (with cryptic exceptions) if it's not a 64-bit call, so you must target either x64 or Any processor type, not x86. </li> </ol>  <p>Create a new console application and make sure that the target framework is 3.5.</p>  <p><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="Create a new console application targetting Framework 3.5" border="0" alt="Create a new console application targetting Framework 3.5" src="media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/00/39/01/metablogapi/0675.image_1691E97C.png" original-url="http://blogs.msdn.com/cfs-file.ashx/__key/CommunityServer-Blogs-Components-WeblogFiles/00-00-00-39-01-metablogapi/0675.image_5F00_1691E97C.png" width="807" height="480" /></p>  <p>Open the Visual Studio Configuration Manager dialog by dropping down the Solution Configurations drop-down on the Visual Studio Standard toolbar (or choosing Configuration Manager from the Build menu):</p>  <p><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="Choose Configuration Manager" border="0" alt="Choose Configuration Manager" src="media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/00/39/01/metablogapi/8117.image_0268A726.png" original-url="http://blogs.msdn.com/cfs-file.ashx/__key/CommunityServer-Blogs-Components-WeblogFiles/00-00-00-39-01-metablogapi/8117.image_5F00_0268A726.png" width="185" height="128" /></p>  <p>Next, add a Solution Platform:</p>  <p><a href="media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/00/39/01/metablogapi/6471.image_4734CB5A.png" original-url="http://blogs.msdn.com/cfs-file.ashx/__key/CommunityServer-Blogs-Components-WeblogFiles/00-00-00-39-01-metablogapi/6471.image_5F00_4734CB5A.png"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/00/39/01/metablogapi/1185.image_thumb_513946B8.png" original-url="http://blogs.msdn.com/cfs-file.ashx/__key/CommunityServer-Blogs-Components-WeblogFiles/00-00-00-39-01-metablogapi/1185.image_5F00_thumb_5F00_513946B8.png" width="720" height="453" /></a></p>  <p>to target Any CPU (or x64)</p>  <p><a href="media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/00/39/01/metablogapi/7450.image_7F631CA5.png" original-url="http://blogs.msdn.com/cfs-file.ashx/__key/CommunityServer-Blogs-Components-WeblogFiles/00-00-00-39-01-metablogapi/7450.image_5F00_7F631CA5.png"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/00/39/01/metablogapi/5481.image_thumb_71442DA8.png" original-url="http://blogs.msdn.com/cfs-file.ashx/__key/CommunityServer-Blogs-Components-WeblogFiles/00-00-00-39-01-metablogapi/5481.image_5F00_thumb_5F00_71442DA8.png" width="353" height="231" /></a></p>  <p>Now you're ready to start building.</p>  <h3>Converting a single document to PDF</h3>  <p>Add references to the <font face="Consolas">Microsoft.SharePoint</font> and <font face="Consolas">Microsoft.Office.Word.Server</font> assemblies.</p>  <p>Add using statements for those assemblies:</p>  <div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:389d961a-ef42-4da1-ab34-11928c01d37f" class="wlWriterEditableSmartContent"> <div style="border: #000080 1px solid; color: #000; font-family: 'Courier New', Courier, Monospace; font-size: 10pt"> <div style="background: #fff; overflow: auto"> <ol style="background: #ffffff; margin: 0; padding: 0 0 0 5px;"> <li><span style="color:#0000ff">using</span> Microsoft.SharePoint;</li> <li style="background: #f3f3f3"><span style="color:#0000ff">using</span> Microsoft.Office.Word.Server.Conversions;</li> </ol> </div> </div> </div>  <p>Add a couple of static string properties to the class that you can adjust to suit the way you've got your SharePoint setup configured:</p>  <div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:2e8cefab-6a25-466e-877f-a02a30df2dd8" class="wlWriterEditableSmartContent"> <div style="border: #000080 1px solid; color: #000; font-family: 'Courier New', Courier, Monospace; font-size: 10pt"> <div style="background: #fff; overflow: auto"> <ol style="background: #ffffff; margin: 0; padding: 0 0 0 5px;"> <li><span style="color:#008000">// If you manually installed Word Automation Services, then replace the name</span></li> <li style="background: #f3f3f3"><span style="color:#008000">// in the following line with the name that you assigned to the service when</span></li> <li><span style="color:#008000">// you installed it.</span></li> <li style="background: #f3f3f3"><span style="color:#0000ff">static</span> <span style="color:#0000ff">string</span> cWordServicesName = <span style="color:#a31515">&quot;Word Automation Services&quot;</span>;</li> <li><span style="color:#0000ff">static</span> <span style="color:#0000ff">string</span> siteUrl = <span style="color:#a31515">&quot;http://localhost&quot;</span>;</li> </ol> </div> </div> </div>  <p>Now you can initiate the conversion of a single document:</p>  <div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:38a8c805-ab79-4b35-be30-8b04f9f14cae" class="wlWriterEditableSmartContent"> <div style="border: #000080 1px solid; color: #000; font-family: 'Courier New', Courier, Monospace; font-size: 10pt"> <div style="background: #000080; color: #fff; font-family: Verdana, Tahoma, Arial, sans-serif; font-weight: bold; padding: 2px 5px">Convert a single document</div> <div style="background: #ddd; max-height: 500px; overflow: auto"> <ol style="background: #ffffff; margin: 0 0 0 2.5em; padding: 0 0 0 5px;"> <li><span style="color:#0000ff">private</span> <span style="color:#0000ff">static</span> <span style="color:#0000ff">void</span> SingleConv()</li> <li style="background: #f3f3f3">{</li> <li>  <span style="color:#0000ff">using</span> (<span style="color:#2b91af">SPSite</span> spSite = <span style="color:#0000ff">new</span> <span style="color:#2b91af">SPSite</span>(siteUrl))</li> <li style="background: #f3f3f3">  {</li> <li>    <span style="color:#2b91af">ConversionJob</span> job = <span style="color:#0000ff">new</span> <span style="color:#2b91af">ConversionJob</span>(cWordServicesName);</li> <li style="background: #f3f3f3">    job.UserToken = spSite.UserToken;</li> <li>    job.Settings.UpdateFields = <span style="color:#0000ff">true</span>;</li> <li style="background: #f3f3f3">    job.Settings.OutputFormat = <span style="color:#2b91af">SaveFormat</span>.PDF;</li> <li>    job.AddFile(siteUrl + <span style="color:#a31515">&quot;/Created%20Docs/MyAwesomeDoc.docx&quot;</span>,</li> <li style="background: #f3f3f3">        siteUrl + <span style="color:#a31515">&quot;/Converted%20Docs/MyAwesomeDoc.pdf&quot;</span>);</li> <li>    job.Start();</li> <li style="background: #f3f3f3">    <span style="color:#2b91af">Console</span>.WriteLine(<span style="color:#a31515">&quot;Job ID: {0} started&quot;</span>, job.JobId);</li> <li>    <span style="color:#2b91af">Console</span>.WriteLine(<span style="color:#a31515">&quot;Press the any key ...&quot;</span>);</li> <li style="background: #f3f3f3">    <span style="color:#2b91af">Console</span>.ReadKey();</li> <li>  }</li> <li style="background: #f3f3f3">}</li> </ol> </div> </div> </div>  <p>There are a few things to note here. </p>  <p>Firstly, you get a reference to the Site using the SharePoint libraries, not the SharePoint Client libraries that we used to write the Word docs to the list in the first place. </p>  <p>Next, you need to pass a user token to the new <font face="Consolas">ConversionJob</font>, and you get that from the SPSite user token. </p>  <p>Third, you specify the output format using the <font face="Consolas">SaveFormat</font> enumeration.</p>  <p>Finally, remember the service is performed asynchronously and so although you get a Job ID back, you don't get any more information about the job status (more on that when we do bulk conversions)</p>  <h3>Converting documents to PDF <em>en-masse</em></h3>  <p>Converting whole libraries at once is also very easy. The <font face="Consolas">ConversionJob</font> class has an <font face="Consolas">AddLibrary()</font> method that takes as parameters a source and destination <font face="Consolas">SPList</font> object.</p>    <div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:fa3a9d35-3ed0-48d9-90b4-4327b49b9438" class="wlWriterEditableSmartContent"> <div style="border: #000080 1px solid; color: #000; font-family: 'Courier New', Courier, Monospace; font-size: 10pt"> <div style="background: #000080; color: #fff; font-family: Verdana, Tahoma, Arial, sans-serif; font-weight: bold; padding: 2px 5px">Converting whole libraries</div> <div style="background: #ddd; overflow: auto"> <ol style="background: #ffffff; margin: 0 0 0 2.5em; padding: 0 0 0 5px;"> <li><span style="color:#0000ff">private</span> <span style="color:#0000ff">static</span> <span style="color:#0000ff">void</span> BulkConv()</li> <li style="background: #f3f3f3">{</li> <li>  <span style="color:#0000ff">using</span> (<span style="color:#2b91af">SPSite</span> spSite = <span style="color:#0000ff">new</span> <span style="color:#2b91af">SPSite</span>(siteUrl))</li> <li style="background: #f3f3f3">  {</li> <li>    <span style="color:#2b91af">Console</span>.WriteLine(<span style="color:#a31515">&quot;Starting conversion job&quot;</span>);</li> <li style="background: #f3f3f3">    <span style="color:#2b91af">ConversionJob</span> job = <span style="color:#0000ff">new</span> <span style="color:#2b91af">ConversionJob</span>(cWordServicesName);</li> <li>    job.UserToken = spSite.UserToken;</li> <li style="background: #f3f3f3">    job.Settings.UpdateFields = <span style="color:#0000ff">true</span>;</li> <li>    job.Settings.OutputFormat = <span style="color:#2b91af">SaveFormat</span>.PDF;</li> <li style="background: #f3f3f3">    job.Settings.OutputSaveBehavior = <span style="color:#2b91af">SaveBehavior</span>.AlwaysOverwrite;</li> <li>    <span style="color:#2b91af">SPList</span> listToConvert = spSite.RootWeb.Lists[<span style="color:#a31515">&quot;Created Docs&quot;</span>];</li> <li style="background: #f3f3f3">    <span style="color:#2b91af">SPList</span> listToPopulate = spSite.RootWeb.Lists[<span style="color:#a31515">&quot;Converted Docs&quot;</span>];</li> <li>    job.AddLibrary(listToConvert, listToPopulate);</li> <li style="background: #f3f3f3">    job.Start();</li> <li>    <span style="color:#2b91af">Console</span>.WriteLine(<span style="color:#a31515">&quot;Bulk conversion job {0} started&quot;</span>, job.JobId);</li> <li style="background: #f3f3f3">    <span style="color:#2b91af">ConversionJobStatus</span> status = <span style="color:#0000ff">new</span> <span style="color:#2b91af">ConversionJobStatus</span>(cWordServicesName,</li> <li>        job.JobId, <span style="color:#0000ff">null</span>);</li> <li style="background: #f3f3f3">    <span style="color:#2b91af">Console</span>.WriteLine(<span style="color:#a31515">&quot;Number of documents in conversion job: {0}&quot;</span>, status.Count);</li> <li>    <span style="color:#0000ff">while</span> (<span style="color:#0000ff">true</span>)</li> <li style="background: #f3f3f3">    {</li> <li>      System.Threading.<span style="color:#2b91af">Thread</span>.Sleep(5000);</li> <li style="background: #f3f3f3">&nbsp;</li> <li>      status.Refresh();</li> <li style="background: #f3f3f3">      <span style="color:#0000ff">if</span> (status.Count == status.Succeeded + status.Failed)</li> <li>      {</li> <li style="background: #f3f3f3">        <span style="color:#2b91af">Console</span>.WriteLine(<span style="color:#a31515">&quot;{2} Completed, Successful: {0}, Failed: {1}&quot;</span>,</li> <li>            status.Succeeded, status.Failed, DateTime.Now);</li> <li style="background: #f3f3f3">        <span style="color:#0000ff">break</span>;</li> <li>      }</li> <li style="background: #f3f3f3">      <span style="color:#2b91af">Console</span>.WriteLine(<span style="color:#a31515">&quot;{2} In progress, Successful: {0}, Failed: {1}&quot;</span>,</li> <li>          status.Succeeded, status.Failed, DateTime.Now);</li> <li style="background: #f3f3f3">    }</li> <li>&nbsp;</li> <li style="background: #f3f3f3">    <span style="color:#2b91af">Console</span>.ReadKey();</li> <li>  }</li> <li style="background: #f3f3f3">}</li> </ol> </div> </div> </div>    <p>Checking the status of the job is straightforward (as long as you have the JobId - a GUID uniquely identifying this conversion job). The <font face="Consolas">ConversionJobStatus</font> object holds information about the conversion job including how many documents are to be converted, how many have been converted successfully and how many have failed. Calling the <font face="Consolas">Refresh()</font> method gets the most up-to-date status and you can use that to poll for completion. Remember that jobs only start every &lt;n&gt; minutes, where n is a setting in SharePoint Central Administration</p>  <p><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="Converting documents is an asynchronous process" border="0" alt="Converting documents is an asynchronous process" src="media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/00/39/01/metablogapi/0020.image_394239C5.png" original-url="http://blogs.msdn.com/cfs-file.ashx/__key/CommunityServer-Blogs-Components-WeblogFiles/00-00-00-39-01-metablogapi/0020.image_5F00_394239C5.png" width="681" height="346" /></p>  <p>The result is a SharePoint list full of PDF files, created without ever needing to open Word.</p>  <p><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="A library full of converted PDFs" border="0" alt="A library full of converted PDFs" src="media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/00/39/01/metablogapi/5383.image_349C093E.png" original-url="http://blogs.msdn.com/cfs-file.ashx/__key/CommunityServer-Blogs-Components-WeblogFiles/00-00-00-39-01-metablogapi/5383.image_5F00_349C093E.png" width="768" height="324" /></p>  <p><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="A converted PDF in Adobe Reader" border="0" alt="A converted PDF in Adobe Reader" src="media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/00/39/01/metablogapi/5415.image_051D74A5.png" original-url="http://blogs.msdn.com/cfs-file.ashx/__key/CommunityServer-Blogs-Components-WeblogFiles/00-00-00-39-01-metablogapi/5415.image_5F00_051D74A5.png" width="542" height="429" /></p>  <h2>Conclusion</h2>  <p>The combination of the OpenXML SDK and Word Automation Services makes server-side document creation simple, scalable and efficient. This is definitely a tool worth adding to your arsenal.</p>  <h2>Source Code</h2>  <p>I've zipped up the two solutions - the document creation (.NET 4.0) WinForms project and the document conversion (.NET3.5) project for you to download and play with. Notice that they are NOT production ready - they're illustrative only. Use them at your peril, your mileage may vary, contents may be hot no guarantees etc … you know the drill.</p>      <p>   <div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:fb3a1972-4489-4e52-abe7-25a00bb07fdf:726c82ec-4b93-42de-ac10-b4fedd0f5da9" class="wlWriterEditableSmartContent"><p>Document Creation Solution <a href="media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/00/39/01/metablogapi/6644.ConvertDocuments_562A2EAF.zip" original-url="http://blogs.msdn.com/cfs-file.ashx/__key/CommunityServer-Blogs-Components-WeblogFiles/00-00-00-39-01-metablogapi/6644.ConvertDocuments_5F00_562A2EAF.zip" target="_blank">Download (241kB)</a><br />Document Conversion Solution <a href="media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/00/39/01/metablogapi/5584.OpenXMLDocumentGeneration_33461AA7.zip" original-url="http://blogs.msdn.com/cfs-file.ashx/__key/CommunityServer-Blogs-Components-WeblogFiles/00-00-00-39-01-metablogapi/5584.OpenXMLDocumentGeneration_5F00_33461AA7.zip" target="_blank">Download (115kB)</a></p></div></p></div>
</div></body>
<script type='text/javascript' src='resource/jquery-1.12.1.min.js'></script>
<script type='text/javascript' src='resource/replace.js'></script>
</html>
